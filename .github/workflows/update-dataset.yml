name: Rolling Dataset Update

on:
  schedule:
    - cron: '0 6 1 */3 *'  # 1st of every 3rd month at 6 AM UTC (quarterly)
  workflow_dispatch:
    inputs:
      years:
        description: 'Years to scrape (space-separated, e.g. "2025 2026")'
        required: false
        default: ''
        type: string
      min_entries:
        description: 'Minimum entries required'
        required: false
        default: 50
        type: number

jobs:
  update-rolling:
    name: Generate Rolling Split
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[scraping]"

      - name: Run rolling update pipeline
        run: |
          YEARS_ARG=""
          if [ -n "${{ inputs.years }}" ]; then
            YEARS_ARG="--years ${{ inputs.years }}"
          fi
          python scripts/update_rolling.py \
            --min-entries ${{ inputs.min_entries || 50 }} \
            $YEARS_ARG \
            -v

      - name: Upload rolling split
        uses: actions/upload-artifact@v4
        with:
          name: rolling-split
          path: data/rolling/
          retention-days: 90
          if-no-files-found: error

  evaluate-rolling:
    name: Evaluate Rolling Split
    runs-on: ubuntu-latest
    needs: update-rolling

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[baselines]"
          pip install bibtex-updater harcx

      - name: Download rolling split
        uses: actions/download-artifact@v4
        with:
          name: rolling-split
          path: data/rolling/

      - name: Run free baselines on rolling split
        continue-on-error: true
        run: |
          python scripts/run_all_baselines.py \
            --split rolling_test \
            --version rolling \
            --baselines free \
            --skip-unavailable \
            --output-dir results/rolling/ \
            -v

      - name: Upload evaluation results
        uses: actions/upload-artifact@v4
        with:
          name: rolling-results
          path: results/rolling/
          retention-days: 90
          if-no-files-found: warn
